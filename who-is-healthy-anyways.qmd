---
title: "Who is healthy anyways? The contribution of measurable social determinants to effect of health disparities on racial gaps in lung function"
format: 
  html:
    toc: true
  docx:
    toc: false
    reference-doc: custom-reference-doc.docx
  pdf:
    toc: false
editor: visual
crossref:
  custom:
    - kind: float
      key: suppfig
      reference-prefix: Figure S
      space-before-numbering: false
    - kind: float
      key: supptab
      reference-prefix: Table S
      space-before-numbering: false
author:
  - name: Amin Adibi
    corresponding: true
    orcid: 0000-0003-2748-4781
    email: amin.adibi@ubc.ca
    affiliations:
      - name: Respiratory Evaluation Sciences Program, Collaboration for Outcomes Research and Evaluation, Faculty of Pharmaceutical Sciences, University of British Columbia
  - name: Christopher Carlsten 
    affiliations:
      - name: Legacy for Airway Health, Vancouver Coastal Health Research Institute
      - name: Division of Respiratory Medicine, Faculty of Medicine, University of British Columbia
      - name: Air Pollution Exposure Lab, Vancouver Coastal Health Research Institute
  - name: Emily Brigham
    affiliations:
      - name: Legacy for Airway Health, Vancouver Coastal Health Research Institute
      - name: Division of Respiratory Medicine, Faculty of Medicine, University of British Columbia
  - name: Don Sin
    affiliations:
      - name: Centre for Heart Lung Innovation (HLI)
      - name: Division of Respiratory Medicine, Faculty of Medicine, University of British Columbia
  - name: Peter Loewen
    affiliations:
      - name: Collaboration for Outcomes Research and Evaluation, Faculty of Pharmaceutical Sciences, University of British Columbia
  - name: Mohsen Sadatsafavi
    affiliations:
      - name: Respiratory Evaluation Sciences Program, Collaboration for Outcomes Research and Evaluation, Faculty of Pharmaceutical Sciences, University of British Columbia
date: "`r Sys.Date()`"
bibliography: references.bib
csl: european-respiratory-journal.csl
execute:
  echo: false
---

## Abstract

**RATIONALE:** Racialized populations disproportionately experience exposures that impair lung function. Race-neutral reference equations mitigate bias due to disparities at the cost of reduced precision. However, it is unclear what proportion of racial gaps in lung function is due to known disparities. Previous studies on the racial gap in lung function between White and Black Americans have attributed 35-39% of the gap in adults to sitting height, 2.5-7.5% to poverty, and 2-4.7% to education. In children, sitting height reportedly accounted for 42-53% of the racial gap, while diet and socio-economic accounted for 7-10% of the gap. We hypothesized that disproportionate impact of environmental and social exposures that is measurable in NAHNES data could help explain a larger proportion of racial gaps in lung function than previously reported. Quantifying the contribution of measurable disparities to racial differences in lung function can inform the debate on the proper assessment of lung function impairment across racial groups.

**METHODS:** We defined reference populations from 18,359 Black and White NHANES 2007-2012 participants. Starting with non-smokers without respiratory symptoms or diagnoses, we sequentially excluded those with confirmed occupational exposure to dust/fumes, physical inactivity, maternal tobacco use, obesity, no home ownership, no insurance, lower education, and self-reported unhealthy diet. Across successive populations, we compared average age-, sex-, and height-adjusted differences in FEV~1~ and FVC between Black and White adults (≥20) and youth (\<20).

**RESULTS:** From the base reference population to the most restrictive, the percentage of Black participants decreased from 19% to 9% in youth and 14% to 4% in adults. The racial gap in FEV~1~ and FVC was reduced by 25% and 26% in children and youth, and by 26% and 19% in adults.

**CONCLUSIONS:** The disparities investigated herein explain up to 25% of the racial gap in lung function among American youth. Further research on adults is required.

------------------------------------------------------------------------

## Background

Racial gaps in measures of lung function have been documented since the late 18^th^ century. For more than a hundred years, pro-slavery scientists in the US weaponized the lower observed lung function in Black people to justify White supremacy [@braun2023]. This racist view was eventually replaced with the notion of innate but benign racial differences in lung function, likely attributable to anthropometric differences. In the twentieth century and with the growing adoption of pre-employment spirometry as a test of fitness for certain workers, occupation standards in the US proposed race-based adjustment of spirometry results to prevent hiring discrimination against Black people [@townsend2022]. Following this, in 2005, the American Thoracic Society (ATS) and the European Respiratory Society (ERS) recommended race-specific reference equations for interpreting pulmonary function tests [@pellegrino2005]. In the past two decades, race-based lung function reference values have been widely used to guide diagnosis, assessment, and management of lung diseases, decide priority for lung transplant surgery, as a fitness for employment eligibility in some industries, and to monitor occupational health and adjudicate insurance claims.

In recent years, increased awareness of the history of structural racism and disparities affecting racialized populations has led to calls to revisit race-based equations in medicine and examine their potential to perpetuate bias and exacerbate existing health disparities [@vyas2020]. Of note is the growing body of literature suggesting that racialized populations experience a disproportionate level of harmful environmental exposures that might hinder lung growth and lower lung function [@marciniuk2023].

Spirometry reference equations are developed with data from "healthy" volunteers, who do not smoke, are asymptomatic, and have not been diagnosed with lung diseases [@quanjer2012; @bowerman2023]. This rather loose definition of what constitutes as healthy could potentially lead to a biased reference populations in which White volunteers have higher lung function values, simply because they were less likely to have been exposed to environmental and social factors that diminish lung function.

Indeed, the effects of social determinants of health (SDoH) on lung function have been discussed in the literature for decades. The 1991 ATS official statements on the interpretative strategies for lung function testing discussed the effects of environmental factors, smoking, indoor and outdoor air pollution, occupational exposures, built environment and socio-economic factors as the main sources of between-individual variability in lung function[@lungfun1991]. The statement also mentions racial differences that persist after adjusting for age, height, smoking, air pollution, and altitude, and hypothesizes that these differences may in part be due to body measurements, environmental differences, nutrition, physical activity, and socioeconomic factors [@lungfun1991]. A 1986 review of between-individual variation in FVC attributed up to 30% of variation to biological sex, up to 30% to age, height, and weight, 10% to race, 3% to measurement error, and 27% to unexplained factors[@becklake1986]. Our study focuses on the proportion of variability that was historically attributed to race can be explained by social determinants of health.

Our understanding of the contribution of environmental and social factors to racial differences in lung function remains limited. A 2022 systematic review found two representative studies in the US population[@holland2022], one focused on adults[@harik-khan2001] and one on children[@harik-khan2004]. The study on adults attributed 35-39% of the racial gap in lung function to sitting height, 2.5-7.5% to poverty, and 2.0-4.7% to education [@harik-khan2001]. In children, sitting height accounted for 42-53% of the racial gap, while diet and socio-economic status accounted for 7-10% of the racial differences [@harik-khan2004]. However, these studies consider a limited set of social exposures, typically comprised of poverty index, BMI, education, employment, and household size and were conducted using older US National Health and Nutrition Examination Survey (NHANES) III survey data (1988–1994).

Our study focuses on whether the proportion of variability that was historically attributed to race can be explained by social determinants of health. We hypothesized that accounting for a more comprehensive set of social and environmental exposures in newer iterations of NHANES data could explain a larger proportion of racial gaps in lung function than previously reported. We have presented a preliminary version of these results in the 2024 European Respiratory Congress in Vienna [@adibi2024].

## Methods

We used data from three cycles of NHANES (2007-2012) with appropriate sampling weights to account for complex survey design. We included self-identified Black and White individuals with valid height recording and baseline spirometry that either met or exceeded ATS collection standards. We defined 10 increasingly healthier reference populations. Starting from the base reference population of non-smokers with no diagnoses of lung diseases or respiratory symptoms, we sequentially excluded those with confirmed occupational exposures, physical inactivity, maternal smoking, obesity (defined as body-mass-index≥30), no home ownership, no insurance, lower education, and self-declared unhealthy diet.

Occupational exposure was defined as having ever been exposed to either mineral dusts (OCQ510), organic dusts (OCQ530), exhaust fumes (OCQ550), or other fumes (OCQ570) at work. Indivdiuals who did not have at least 10 minutes of vigorous or moderate activity in a typical week, either for work or recreationally (PAQ605, PAQ620, PAQ650, PAQ665), were considered physically inactive. Lower educated individuals were defined as adults 20 years of age and older with a high school or a GED degree or lower (DMDEDUC2), and 6-19 years old who were neither in school nor on vacation from school (DMDSCHOL). Individuals with self-declared their dietary health as either poor or fair (DBQ700) were considered to have a unhealthy diet.

For each reference population, the racial gap was calculated as the average difference between Black and White populations adjusted by age, height, and sex in a linear regression. We evaluated the reduction in the racial gap separately for youth (\<20 yrs) and adults (≥20 yrs). The distinction between adults and youth was made based on how NHANES data is structured; for example, the educational level variable is only available for those 20 years of age and older.

In the sensitivity analyses, we evaluated the results separately for males and females and those born inside the US. We also evaluated the proportion of the racial gap in lung function that can be explained by poverty alone.

All data preparation and analysis was performed in R v4.4.2 using reproducible Quarto documents. A fully reproducible analysis code is publicly available at <https://github.com/aminadibi/who-is-healthy-anyways/>.

```{r, warning=FALSE, message=FALSE}
rm(list = ls(all.names = TRUE))
library(tidyverse)
library(purrr)
library(naniar)
library(tidymodels)
library(ggthemes)
library(patchwork)
library(hrbrthemes)
library(table1)
library(rspiro)
library(stringr)

compute_gap_reduction <- function(df, measure) {
  df %>% 
    filter(Measure == measure) %>%
    summarise(Reduction = (last(estimate) - first(estimate)) / first(estimate)) %>% 
    round(2)
}

createCohort <- function (ageGroup, incomePovertyRatioOnly=FALSE, sex='all', BirthCountry='all', homeOwnershipOnly=FALSE) {
  if (!(ageGroup %in% c("adult", "youth", "all_ages"))) 
    stop("Invalid age group")
  if (!(BirthCountry %in% c("all", "US", "Other countries"))) 
    stop("Invalid BirthCountry")
  if (!(sex %in% c("all", "male", "female"))) 
    stop("Invalid sex")
  

  nhanes <- readRDS("nhanes_2007_2012.rds") 
  
  stopifnot((nhanes %>% count()) == 30442) # Ensure we have the correct n
  stopifnot((nhanes %>% filter(race %in% c(3,4)) %>% count()) == 18359) 
  stopifnot((nhanes %>% drop_na(fev1_pre, fvc_pre)  %>% count()) == 20050) 
  
  if (sex=='female') {
    warning('only females are included.')
    nhanes <- nhanes %>% filter(sex==2)
  }
  
  if (sex=='male') {
    warning('only males are included.')
    nhanes <- nhanes %>% filter(sex==1)
  }

  nhanes <- nhanes %>%
    mutate(fev1 = fev1_pre/1000,
           fvc  = fvc_pre/1000) %>%
    drop_na(fev1, fvc) %>%
    filter(spiro_status_pre == 1) %>%
    filter(fev1_quality_pre == "A" | fev1_quality_pre == "B") %>%
    filter(fvc_quality_pre  == "A" | fvc_quality_pre  == "B") %>%
    mutate(race_text_nhanes = str_remove(race_text_nhanes, "Non-Hispanic "))
  
  message(paste0("NHANES N (excluding missing or low quality spiro: ", 
                 (nhanes %>% count())))
  
  if (BirthCountry=='all'){
      nhanes_bw <- nhanes %>%
        filter(race %in% c(3,4))
  } else  {
          nhanes_bw <- nhanes %>%
            filter(race %in% c(3,4)) %>%
            filter(birth_country==BirthCountry)
  } 

  message(paste0("NHANES Black and White N (excluding missing or low quality spiro: ", 
                 (nhanes_bw %>% count())))
  
if (ageGroup=="adult") {
nhanes_bw <- nhanes_bw %>%
  filter(age>=20)

  message(paste0(ageGroup, "-NHANES : ", 
                 (nhanes_bw %>% count())))
}
  
if (ageGroup=="youth") {
nhanes_bw <- nhanes_bw %>%
  filter(age<20)

  message(paste0(ageGroup, "-NHANES : ", 
                 (nhanes_bw %>% count())))
}
  
if (ageGroup=="all_ages") {

  message(paste0(ageGroup, "-NHANES : ", 
                 (nhanes_bw %>% count())))
}
 
#vis_miss(nhanes_bw, warn_large_data = F)

ref0 <- nhanes_bw %>%
   mutate(
        race_spiro_gli2012            = case_match(race_text_nhanes,
                                     "Non-Hispanic White" ~ "1"  ,
                                     "Non-Hispanic Black" ~ "2" ,
                                     "Non-Hispanic Asian" ~ "4", 
                                     "Mexican American" ~ "1", 
                                     "Other Hispanic" ~ "1",
                                     "Other Race - Including Multi-Racial" ~ "5"
                                     ),
        sex_text           = case_match(sex,
                                     "1" ~ "Male"  ,
                                     "2" ~ "Female" ),
        predicted_fev1_gli2012 = rspiro::pred_GLI(age=age, height=height/100, 
                                                  gender=sex, ethnicity=race_spiro_gli2012,
                                                  param="FEV1"),
        predicted_fev1_gli_global = rspiro::pred_GLIgl(age=age, height=height/100, 
                                                  gender=sex, 
                                                  param="FEV1"),
        perc_pred_fev1_gli2012 = rspiro::pctpred_GLI(age=age, height=height/100, 
                                                  gender=sex, ethnicity=race_spiro_gli2012,
                                                  FEV1=fev1),
        zscore_fev1_gli2012 = rspiro::zscore_GLI(age=age, height=height/100, 
                                                  gender=sex, ethnicity=race_spiro_gli2012,
                                                  FEV1=fev1),
        perc_pred_fev1_gli2012_whiteforall = rspiro::pctpred_GLI(age=age, height=height/100, 
                                                  gender=sex, ethnicity=1,
                                                  FEV1=fev1),
        perc_pred_fev1_gli2012_otherforall = rspiro::pctpred_GLI(age=age, height=height/100, 
                                                  gender=sex, ethnicity=5,
                                                  FEV1=fev1),
        perc_pred_fev1_gli_global = rspiro::pctpred_GLIgl(age=age, height=height/100, 
                                                  gender=sex,
                                                  FEV1=fev1),
        zscore_fev1_gli_global = rspiro::zscore_GLIgl(age=age, height=height/100, 
                                                  gender=sex,
                                                  FEV1=fev1)
      
        ) 
  

ref0 %>%
  group_by(race) %>%
  count()

ref1 <- ref0 %>%
  filter ((is.na(current_smoke) | (current_smoke == "3")) &
         (is.na(ever_100_smoke) | (ever_100_smoke != "1")) &
         (is.na(last_5_days_cigarettes) |  (last_5_days_cigarettes != "1")) &
         (is.na(last_5_days_pipes) | (last_5_days_pipes != "1")) &
         (is.na(last_5_days_cigars) | (last_5_days_cigars != "1")) &
         (is.na(ever_asthma) | (ever_asthma !="1")) &
         (is.na(ever_bronchitis) | (ever_bronchitis != "1")) &
         (is.na(ever_emphysema) | (ever_emphysema != "1")) &
         (is.na(cough_3_month) | (cough_3_month!=1)) & 
         (is.na(phlegm_3_month) | (phlegm_3_month!=1)) & 
         (is.na(wheezing_past_yr) | (wheezing_past_yr!=1)) & 
         (is.na(dry_cough_night_past_yr) | (dry_cough_night_past_yr!=1))) %>%
  mutate(ref="reference")

if (incomePovertyRatioOnly) {
  ref2 <- ref1 %>% filter(is.na(income_poverty_ratio) | (income_poverty_ratio>=1)) %>%
  mutate(ref="income_poverty_ratio>=1")
  ref3 <- ref2 %>% filter(is.na(income_poverty_ratio) | (income_poverty_ratio>=1.5)) %>%
  mutate(ref="income_poverty_ratio>=1.5")
  ref4 <- ref3 %>% filter(is.na(income_poverty_ratio) | (income_poverty_ratio>=2)) %>%
  mutate(ref="income_poverty_ratio>=2")
  ref5 <- ref4 %>% filter(is.na(income_poverty_ratio) | (income_poverty_ratio>=2.5))  %>%
  mutate(ref="income_poverty_ratio>=2.5")
  ref6 <- ref5 %>% filter(is.na(income_poverty_ratio) | (income_poverty_ratio>=3)) %>%
  mutate(ref="income_poverty_ratio>=3")
  ref7 <- ref6 %>% filter(is.na(income_poverty_ratio) | (income_poverty_ratio>=3.5))  %>%
  mutate(ref="income_poverty_ratio>=3.5")
  ref8 <- ref7 %>% filter(is.na(income_poverty_ratio) | (income_poverty_ratio>=4))  %>%
  mutate(ref="income_poverty_ratio>=4")
  ref9 <- ref8 %>% filter(is.na(income_poverty_ratio) | (income_poverty_ratio>=4.5))  %>%
  mutate(ref="income_poverty_ratio>=4.5")
  ref10<- ref9 %>% filter(is.na(income_poverty_ratio) | (income_poverty_ratio>=5))  %>%
  mutate(ref="income_poverty_ratio>=5")
  refs <- list(ref1, ref2, ref3, ref4, ref5, ref6, ref7, ref8, ref9, ref10)

}

if (homeOwnershipOnly) {
  ref2 <- ref1 %>% 
    filter(is.na(home_ownership) | (home_ownership==1)) %>%
  mutate(ref="home owner")
  refs <- list(ref1, ref2)

}


if (!incomePovertyRatioOnly & !homeOwnershipOnly) {
ref2 <- ref1 %>%
    filter((is.na(mineral_dusts) | (mineral_dusts!=1)) & 
         (is.na(organic_dusts)   | (organic_dusts!=1)) & 
         (is.na(exhaust_fumes)   | (exhaust_fumes!=1)) & 
         (is.na(other_fumes)     | (other_fumes!=1))) %>%
  mutate(ref="job unexposed")
  
  
ref3 <- ref2 %>%
      filter((is.na(vigorous_work) | (vigorous_work==1)) | 
         (is.na(vigorous_recreational)   | (vigorous_recreational==1)) | 
         (is.na(moderate_work)   | (moderate_work==1)) | 
         (is.na(moderate_recreational)   | (moderate_recreational==1)))  %>%
  mutate(ref="physically active")

ref4 <- ref3 %>%
      filter((is.na(maternal_smoke) | (maternal_smoke!=1))) %>% #TODO Maternal smoke not available for those over 15 years
  mutate(ref="no maternal smoke")
  
ref5 <- ref4 %>%  
      filter((is.na(smoker_in_household) | (smoker_in_household != "1"))) %>%
      mutate(ref="no 2ndhand smoke")

ref6 <- ref5 %>%
      filter((is.na(bmi) | (bmi<=30))) %>%
  mutate(ref="not obese")

ref7 <- ref6 %>%
    filter(is.na(home_ownership) | (home_ownership==1))  %>%
  mutate(ref="home owner")

ref8 <- ref7 %>%
     filter((is.na(has_insurance) | 
               (has_insurance==1)))  %>%
  mutate(ref="insured")

if (ageGroup=="adult") {
  ref9 <- ref8 %>%
    filter(is.na(education_adults) | (education_adults %in% c(4,5)))  %>%
  mutate(ref="educated")
}

if (ageGroup=="youth") {
  ref9 <- ref8 %>%
    filter(is.na(now_attending_school) | (now_attending_school != 3)| (age<6))  %>%
  mutate(ref="educated")
}

ref10 <- ref9 %>%
     filter((is.na(healthy_diet) | 
               (healthy_diet==1) | 
               (healthy_diet==2) | 
               (healthy_diet==3)))  %>%
  mutate(ref="healthy diet")


refs <- list(ref1, ref2, ref3, ref4, ref5, ref6, ref7, ref8, ref9, ref10)

}

return(refs)
}
 # Note that maternal smoke variable is only available for youth up to 15 years old.

```

## Results

Of the 18,359 self-identified Black and White participants in NHANES 2007-2012, 10,457 participants had valid height and high quality spirometry. This included 7,533 adults and 2,924 youth.

The flow of participants is shown in @fig-flowchart.

```{mermaid, include=T}
%%| label: fig-flowchart
%%| fig-cap: Flow of participants
flowchart TD
    B[n=30,442] -- excluded missing FEV1 or FVC --> C[n=20,050]
    C -- excluded low quality spirometry --> D[n=17,032]
    D -- included patients self-identified as Black or White --> E[n=10,457]
    E -- excluded smokers, and those with respiratory diagnoses or symptoms --> F[n=4,843]
    F -- Adults --> A0[n=2,785]
    F -- Youth  --> Y0[n=2,058]

```

Characteristics of participants is summarized in @tbl-table1 .

```{r}
#| label: tbl-table1
#| tbl-cap: Characteristics of Participants Included in the Study
#TODO this is great, but does not consider survey weights
#TODO this does not show missingness and value judgments around how we handled it properly.

 
 table1 <- readRDS("nhanes_2007_2012.rds") %>%
    mutate(fev1 = fev1_pre/1000,
           fvc  = fvc_pre/1000) %>%
    drop_na(fev1, fvc) %>%
    filter(spiro_status_pre == 1) %>%
    filter(fev1_quality_pre == "A" | fev1_quality_pre == "B") %>%
    filter(fvc_quality_pre  == "A" | fvc_quality_pre  == "B") %>%
    filter(race %in% c(3,4)) %>%
    filter ((is.na(current_smoke) | (current_smoke == "3")) &
         (is.na(ever_100_smoke) | (ever_100_smoke != "1")) &
         (is.na(last_5_days_cigarettes) |  (last_5_days_cigarettes != "1")) &
         (is.na(last_5_days_pipes) | (last_5_days_pipes != "1")) &
         (is.na(last_5_days_cigars) | (last_5_days_cigars != "1")) &
         (is.na(ever_asthma) | (ever_asthma !="1")) &
         (is.na(ever_bronchitis) | (ever_bronchitis != "1")) &
         (is.na(ever_emphysema) | (ever_emphysema != "1")) &
         (is.na(cough_3_month) | (cough_3_month!=1)) & 
         (is.na(phlegm_3_month) | (phlegm_3_month!=1)) & 
         (is.na(wheezing_past_yr) | (wheezing_past_yr!=1)) & 
         (is.na(dry_cough_night_past_yr) | (dry_cough_night_past_yr!=1))) %>%
    mutate(age_group = ifelse(age>=20, "Adults", "Youth"),
          sex_text   = case_match(sex,
                                     "1" ~ "Male"  ,
                                     "2" ~ "Female" ),
          cough_3_month = case_match(cough_3_month,
                                     1 ~ "Yes"  ,
                                     2 ~ "No"),
          phlegm_3_month = case_match(phlegm_3_month,
                                     1 ~ "Yes"  ,
                                     2 ~ "No"),
          wheezing_past_yr = case_match(wheezing_past_yr,
                                     1 ~ "Yes"  ,
                                     2 ~ "No"),
          dry_cough_night_past_yr = case_match(dry_cough_night_past_yr,
                                     1 ~ "Yes"  ,
                                     2 ~ "No"),
          ever_asthma = case_match(ever_asthma,
                                     "1" ~ "Yes"  ,
                                     "2" ~ "No"),
          ever_bronchitis = case_match(ever_bronchitis,
                                     "1" ~ "Yes"  ,
                                     "2" ~ "No"),
          ever_emphysema = case_match(ever_emphysema,
                                     "1" ~ "Yes"  ,
                                     "2" ~ "No"),
          ever_100_smoke = case_match(ever_100_smoke,
                                     "1" ~ "Yes"  ,
                                     "2" ~ "No"),
          current_smoke = case_match(current_smoke,
                                     "1" ~ "Everyday"  ,
                                     "2" ~ "Some days",
                                     "3" ~ "Not at all"),
          education_adults = case_match(education_adults,
                                     "1" ~ "Less than 9th grade"  ,
                                     "2" ~ "9-11th grade",
                                     "3" ~ "High school graduate",
                                     "4" ~ "Some college or AA degree",
                                     "5" ~ "College graduate or above"),
          now_attending_school = case_match(now_attending_school,
                                          1 ~ "In school",
                                          2 ~ "Between grades",
                                          2 ~ "Not in school"),
          smoker_in_household = case_match(smoker_in_household,
                                          1 ~ "Yes",
                                          2 ~ "No"),
          maternal_smoke = case_match(maternal_smoke,
                                          1 ~ "Yes",
                                          2 ~ "No"),
          home_ownership = case_match(home_ownership,
                                          1 ~ "Owned or being bought",
                                          2 ~ "Rented",
                                          3 ~ "Other arrangements"),
          mineral_dusts = case_match(mineral_dusts,
                                          1 ~ "Yes",
                                          2 ~ "No"),
          organic_dusts = case_match(organic_dusts,
                                          1 ~ "Yes",
                                          2 ~ "No"),
          exhaust_fumes = case_match(exhaust_fumes,
                                          1 ~ "Yes",
                                          2 ~ "No"),
          other_fumes = case_match(other_fumes,
                                          1 ~ "Yes",
                                          2 ~ "No"),
          healthy_diet = case_match(healthy_diet,
                                          1 ~ "Excellent",
                                          2 ~ "Very good",
                                          3 ~ "Good",
                                          4 ~ "Fair",
                                          5 ~ "Poor"),
          vigorous_work = case_match(vigorous_work,
                                          1 ~ "Yes",
                                          2 ~ "No"),
          moderate_work = case_match(moderate_work,
                                          1 ~ "Yes",
                                          2 ~ "No"),
          vigorous_recreational = case_match(vigorous_recreational,
                                          1 ~ "Yes",
                                          2 ~ "No"),
          moderate_recreational = case_match(moderate_recreational,
                                          1 ~ "Yes",
                                          2 ~ "No"),
  
          smoker=
       !((is.na(current_smoke) | (current_smoke == "3")) &
         (is.na(ever_100_smoke) | (ever_100_smoke != "1")) &
         (is.na(last_5_days_cigarettes) |  (last_5_days_cigarettes != "1")) &
         (is.na(last_5_days_pipes) | (last_5_days_pipes != "1")) &
         (is.na(last_5_days_cigars) | (last_5_days_cigars != "1"))),
         resp_symptoms = !((is.na(cough_3_month) | (cough_3_month!=1)) & 
         (is.na(phlegm_3_month) | (phlegm_3_month!=1)) & 
         (is.na(wheezing_past_yr) | (wheezing_past_yr!=1)) & 
         (is.na(dry_cough_night_past_yr) | (dry_cough_night_past_yr!=1))),
         resp_dx = !((is.na(ever_asthma) | (ever_asthma !="1")) &
         (is.na(ever_bronchitis) | (ever_bronchitis != "1")) &
         (is.na(ever_emphysema) | (ever_emphysema != "1"))),
         physically_active = ((is.na(vigorous_work) | (vigorous_work==1)) | 
         (is.na(vigorous_recreational)   | (vigorous_recreational==1)) | 
         (is.na(moderate_work)   | (moderate_work==1)) | 
         (is.na(moderate_recreational)   | (moderate_recreational==1))),
         occupational_exposure = !((is.na(mineral_dusts) | (mineral_dusts!=1)) & 
         (is.na(organic_dusts)   | (organic_dusts!=1)) & 
         (is.na(exhaust_fumes)   | (exhaust_fumes!=1)) & 
         (is.na(other_fumes)     | (other_fumes!=1))),
         home_owner = (is.na(home_ownership) | (home_ownership==1)), 
         healthy_eater = ((is.na(healthy_diet) | 
               (healthy_diet==1) | 
               (healthy_diet==2) | 
               (healthy_diet==3)))
         ) 
 
 label(table1$race_text_nhanes) <- "Race and Ethnicity"
 label(table1$age) <- "Age (years)"
 label(table1$fev1) <- "FEV1 (L)"
 label(table1$fvc) <- "FVC (L)"
 label(table1$sex_text) <- "Biological Sex at Birth"
 label(table1$smoker_in_household) <- "Smoker in household"
 label(table1$maternal_smoke) <- "Maternal smoke during pregnancy (For youth)"
 label(table1$mineral_dusts) <- "Occupational Exposure to Mineral Dusts"
 label(table1$organic_dusts) <- "Occupational Exposure to Organic Dusts"
 label(table1$exhaust_fumes) <- "Occupational Exposure to Exhaust Fumes"
 label(table1$other_fumes) <- "Occupational Exposure to Other Fumes"
 label(table1$education_adults) <- "Education Level for Adults"
 label(table1$now_attending_school) <- "Currently Attending School (for youth)"
 label(table1$healthy_diet) <- "Self-evaluated Diet Health"
 label(table1$vigorous_work) <- "Vigorous Activity at Work (10 min/week)"
 label(table1$vigorous_recreational) <- "Recreational Vigorous Activity (10 min/week)"
 label(table1$moderate_work) <- "Moderate Activity at Work (10 min/week)"
 label(table1$moderate_recreational) <- "Recreational Moderate Activity (10 min/week)"
 label(table1$bmi) <- "Body Mass Index"
 label(table1$income_poverty_ratio) <- "Income to Poverty Ratio"
 label(table1$home_owner) <- "Home Owner"
 label(table1$has_insurance) <- "Health Insurance"
 
 
 table1(~ age + race_text_nhanes + sex_text + 
          fev1 + fvc +
          smoker_in_household + maternal_smoke +
          mineral_dusts + organic_dusts + exhaust_fumes + other_fumes +
          income_poverty_ratio + home_owner + 
          education_adults + now_attending_school + 
          healthy_diet + vigorous_work + moderate_work + vigorous_recreational + moderate_recreational + bmi 
          | age_group, table1)
 
```

```{r}

race_estimate <- function(df, outcome, single_sex=FALSE) {
  if (single_sex) {formula_text <- as.formula(paste0(outcome, " ~ age + height + race"))}
  else {formula_text <- as.formula(paste0(outcome, " ~ sex + age + height + race"))}
  lm_fit <- lm(formula_text, data=df, weights=MEC6YR)
  res <- (tidy(lm_fit, conf.int=TRUE)%>%filter(term=='race4')) 
  return(res)
}

plot_racial_gap_change <- function(refs_adult_list, refs_youth_list, single_sex = FALSE, 
                                   metric1="fev1", metric2="fvc"){
  
  sequence_adult <- lapply(refs_adult_list, function(x) unique(x$ref))
  sequence_adult_df <- do.call(rbind.data.frame, sequence_adult)
  names(sequence_adult_df) <- 'ref'
  sequence_adult_df$ref <- factor(sequence_adult_df$ref, levels=sequence_adult_df$ref)
  
  sequence_youth <- lapply(refs_youth_list, function(x) unique(x$ref))
  sequence_youth_df <- do.call(rbind.data.frame, sequence_youth)
  names(sequence_youth_df) <- 'ref'
  sequence_youth_df$ref <- factor(sequence_youth_df$ref, levels=sequence_youth_df$ref)
  
  race_coeffs_fev1_adult <- 
    map_df(refs_adult_list, function(x) race_estimate(x, metric1, single_sex = single_sex)) %>% 
    mutate(sequence=sequence_adult_df$ref,
           Measure = metric1) 
  
  race_coeffs_fev1_youth <-
    map_df(refs_youth_list, function(x) race_estimate(x, metric1, single_sex = single_sex)) %>%
    mutate(sequence=sequence_youth_df$ref,
           Measure = metric1) 
  
  race_coeffs_fvc_adult <- 
    map_df(refs_adult_list, function(x) race_estimate(x, metric2, single_sex = single_sex)) %>%
    mutate(sequence=sequence_adult_df$ref,
           Measure = metric2)
  
  race_coeffs_fvc_youth <- 
    map_df(refs_youth_list, function(x) race_estimate(x, metric2, single_sex = single_sex)) %>% 
    mutate(sequence=sequence_youth_df$ref,
           Measure = metric2)
  
  race_coeffs_adult <- rbind(race_coeffs_fev1_adult, race_coeffs_fvc_adult)
  race_coeffs_youth <- rbind(race_coeffs_fev1_youth, race_coeffs_fvc_youth)
  
  # report Gap Reduction
  gap_reduction_messages <- function(race_coeffs, age_group) {
    measures <- c(metric1, metric2)
    for (measure in measures) {
      message(paste0("For ", measure, " in ", age_group, ", the reduction in gap was ", 
                     compute_gap_reduction(race_coeffs, measure)))
    }
  }

  gap_reduction_messages(race_coeffs_adult, "adults")
  gap_reduction_messages(race_coeffs_youth, "youth")
  
  # Plot Racial Gap
  plot_racial_gap <- function(race_coeffs, age_group, suppress_legend=FALSE) {
    p <- ggplot(race_coeffs, aes(y=-estimate, x=sequence, colour=Measure)) + 
      geom_point() +
      geom_errorbar(aes(ymin=-conf.low, ymax=-conf.high), width=0.2, alpha=0.8) +
      ylim(0, 1.2) + 
      ylab("Racial Gap (L)") +
      xlab("") +
      theme_few() + theme(axis.text.x = element_text(angle = 90, size=7, hjust=0.95,vjust=0.2))
    
    if (suppress_legend) {
      p <- p +  theme(legend.position="none")
    }
    return(p)
  }
  
  racial_gap_adult <- plot_racial_gap(race_coeffs_adult, "adults")
  racial_gap_youth <- plot_racial_gap(race_coeffs_youth, "youth", suppress_legend=TRUE)

  # Combine refs_df_adult and refs_df_youth
  combine_refs_df <- function(refs_list) {
    refs_df <- do.call(rbind, lapply(seq_along(refs_list), function(i) refs_list[[i]] %>% mutate(ref = i)))
    refs_df %>%
      mutate(ref=factor(ref)) %>%
      group_by(ref) %>%
      count(race_text_nhanes, wt = MEC6YR) %>%
      mutate(perc = n / sum(n)) %>%
      ungroup()
  }
  
  refs_df_percent_adult <- combine_refs_df(refs_adult_list)
  refs_df_percent_youth <- combine_refs_df(refs_youth_list)

  plot_gap_perc <- function(refs_df_percent, title, suppress_legend=FALSE) {
    p <- ggplot(refs_df_percent) +
      geom_bar(aes(x=ref, y=perc, fill=race_text_nhanes), stat="identity", position = "fill") +
      geom_text(aes(x=ref, y=perc, fill=race_text_nhanes, label=scales::percent(perc, accuracy = 1)), position = position_stack(vjust = 0.5), color = "white", size = 2) +
      scale_y_continuous(labels=scales::percent) +
      ggtitle(title) +
      labs(x = "", y = "Percentage") +
      guides(fill=guide_legend(title="Race")) +
      theme_few() + theme(axis.text.x = element_blank())
    
    if (suppress_legend) {
      p <- p +  theme(legend.position="none", axis.text.x=element_blank())
    }
    return(p)
  }

  gap_perc_black_adult <- plot_gap_perc(refs_df_percent_adult, "Adults (≥20 yrs)")
  gap_perc_black_youth <- plot_gap_perc(refs_df_percent_youth, "Youth (<20 yrs)", suppress_legend=TRUE)

    p <- (((gap_perc_black_youth/racial_gap_youth) + 
           plot_layout(axes = "collect")) | 
          ((gap_perc_black_adult/racial_gap_adult) + 
             plot_layout(axes = "collect")) ) + 
    plot_annotation(tag_levels = 'A') 
  
  return(p)
}


predPlot <- function(df) {
  lm_fit_with_race <- lm(fev1 ~ sex + age + height + race, data=df)
  df <- df %>%
    mutate(.pred = predict(lm_fit_with_race, df))
  
  ggplot(df) +
    geom_point(aes(y=fev1, x=age), size=0.1, alpha=0.4, colour='salmon') + 
    geom_smooth(aes(y=fev1, x=age), colour='salmon') +
    geom_point(aes(y=.pred, x=age), size=0.1, alpha=0.4) +
    geom_smooth(aes(y=.pred, x=age)) +
    facet_wrap(~sex) + 
    theme_few()
  
}

```

From the base reference population to the most restrictive, the number of included participants decreased from 4,843 to 1,099, while the proportion of Black participants decreased from 19% to 9% in youth and 14% to 4% in adults, as shown in @fig-racialgap. After excluding those with various social and environmental exposures, the racial gap in FEV~1~ and FVC was reduced by 26% and 19% in adults, and 25% and 26% in youth.

```{r, warning=FALSE, message=FALSE}
#| label: fig-racialgap
#| fig-cap: Changes in lung function racial gaps in successively more restrictive reference populations
 
refs_adult <- createCohort("adult")
message("Adult counts:")
message(map_df(refs_adult, count))

refs_youth <- createCohort("youth")
message("Youth counts:")
message(map_df(refs_youth, count))

plot_racial_gap_change(refs_adult, refs_youth)

```

### Secondary and Sensitivity Analyses

#### Biological Sex

We also looked at the racial gap in lung function from the most permissive to the most restrictive reference population, separately for females and males. In females, the proportion of Black participants decreased from 20% to 10% in youth and 15% to 5% in adults. After excluding those with various social and environmental exposures, the racial gap in FEV~1~ and FVC was reduced by 27% and 20% in adults, and 16% and 19% in youth, respectively (appendix @suppfig-females). In males, the proportion of Black participants decreased from 17% to 8% in youth and 12% to 4% in adults. After excluding those with various social and environmental exposures, the racial gap in FEV~1~ and FVC was reduced by 14% and 8% in adults, and 35% and 34% in youth (appendix @suppfig-males).

#### Home Ownership, BMI, and Occupation

After excluding patients solely based on home ownership, BMI, and occupation, the proportion of Black participants decreased from 19% to 10% in youth and 14% to 11% in adults, as shown in @fig-racialgap-home-bmi-job. After limiting reference populations to non-obese homeowners without occupational exposures to dusts and fumes the racial gap in FEV~1~ and FVC was reduced by 20% and 16% in adults, and 21% and 19% in youth.

```{r, warning=FALSE, message=FALSE}
#| label: fig-racialgap-home-bmi-job
#| fig-cap: Changes in lung function racial gaps after exclusions based on home ownership, BMI, and occupation
createCohort3Factor <- function (ageGroup,sex='all') {
  if (!(ageGroup %in% c("adult", "youth"))) 
    stop("Invalid age group")
  if (!(sex %in% c("all", "male", "female"))) 
    stop("Invalid sex")
  

  nhanes <- readRDS("nhanes_2007_2012.rds") 
  
  stopifnot((nhanes %>% count()) == 30442) # Ensure we have the correct n
  stopifnot((nhanes %>% filter(race %in% c(3,4)) %>% count()) == 18359) 
  stopifnot((nhanes %>% drop_na(fev1_pre, fvc_pre)  %>% count()) == 20050) 
  
  if (sex=='female') {
    warning('only females are included.')
    nhanes <- nhanes %>% filter(sex==2)
  }
  
  if (sex=='male') {
    warning('only males are included.')
    nhanes <- nhanes %>% filter(sex==1)
  }

  nhanes <- nhanes %>%
    mutate(fev1 = fev1_pre/1000,
           fvc  = fvc_pre/1000) %>%
    drop_na(fev1, fvc) %>%
    filter(spiro_status_pre == 1) %>%
    filter(fev1_quality_pre == "A" | fev1_quality_pre == "B") %>%
    filter(fvc_quality_pre  == "A" | fvc_quality_pre  == "B") %>%
    mutate(race_text_nhanes = str_remove(race_text_nhanes, "Non-Hispanic "))
  
  message(paste0("NHANES N (excluding missing or low quality spiro: ", 
                 (nhanes %>% count())))
  
  nhanes_bw <- nhanes %>%
        filter(race %in% c(3,4))

  message(paste0("NHANES Black and White N (excluding missing or low quality spiro: ", 
                 (nhanes_bw %>% count())))
  
if (ageGroup=="adult") {
nhanes_bw <- nhanes_bw %>%
  filter(age>=20)

  message(paste0(ageGroup, "-NHANES : ", 
                 (nhanes_bw %>% count())))
}
  
if (ageGroup=="youth") {
nhanes_bw <- nhanes_bw %>%
  filter(age<20)

  message(paste0(ageGroup, "-NHANES : ", 
                 (nhanes_bw %>% count())))
}

ref0 <- nhanes_bw

ref0 %>%
  group_by(race) %>%
  count()

ref1 <- ref0 %>%
  filter ((is.na(current_smoke) | (current_smoke == "3")) &
         (is.na(ever_100_smoke) | (ever_100_smoke != "1")) &
         (is.na(last_5_days_cigarettes) |  (last_5_days_cigarettes != "1")) &
         (is.na(last_5_days_pipes) | (last_5_days_pipes != "1")) &
         (is.na(last_5_days_cigars) | (last_5_days_cigars != "1")) &
         (is.na(ever_asthma) | (ever_asthma !="1")) &
         (is.na(ever_bronchitis) | (ever_bronchitis != "1")) &
         (is.na(ever_emphysema) | (ever_emphysema != "1")) &
         (is.na(cough_3_month) | (cough_3_month!=1)) & 
         (is.na(phlegm_3_month) | (phlegm_3_month!=1)) & 
         (is.na(wheezing_past_yr) | (wheezing_past_yr!=1)) & 
         (is.na(dry_cough_night_past_yr) | (dry_cough_night_past_yr!=1))) %>%
  mutate(ref="reference")


ref2 <- ref1 %>%
      filter((is.na(bmi) | (bmi<=30))) %>%
      filter(is.na(home_ownership) | (home_ownership==1)) %>%
    filter((is.na(mineral_dusts) | (mineral_dusts!=1)) & 
         (is.na(organic_dusts)   | (organic_dusts!=1)) & 
         (is.na(exhaust_fumes)   | (exhaust_fumes!=1)) & 
         (is.na(other_fumes)     | (other_fumes!=1))) %>%
      filter((is.na(bmi) | (bmi<=30))) %>%
  mutate(ref="home-job-bmi") 


refs <- list(ref1, ref2)

return(refs)
}

plot_racial_gap_change(createCohort3Factor("adult"), createCohort3Factor("youth"))
```

In the supplementary material, we also explored the intersection of self-identified race and country of origin (@suppfig-usborn).

## Discussion

Our results reinforce the critical role of environmental, social, and lifestyle factors in shaping health outcomes and suggest that a substantial portion of the racial gap in lung function can be explained by SDoH, with up to 26% of the gap in adults, and as much as 35% in males under 20 years of age, attributed to these factors. Our findings attribute a higher proportion of racial differences in lung function to social and environmental exposures than previously reported [@harik-khan2001; @harik-khan2004].

The higher explained proportion of the racial gap in lung function among individuals born in the US (i.e., up to 36% of the racial gap in adult FEV~1~ explained by the studied exposures) suggests that US-specific systemic factors such as racism, segregation, red-zoning, and other socio-economic inequities profoundly impact lung health. This aligns with several studies have reported significantly higher health burdens in US-born racialized people compared to racialized immigrants to the US [@doamekpor2015; @brown2017] and the growing body of literature that implicates historical and structural inequities, such as redlining and differential environmental exposures, in perpetuating health disparities among racialized communities in general [@nardone2020; @schuyler2022; @gaffney2021; @levy2018].

Our analysis revealed that excluding individuals based on home ownership, BMI, and occupational exposures accounts for a significant portion of the explainable racial gap, indicating that financial stability, physical health, and work-related factors are pivotal contributors to lung function disparities.

Our study highlights the necessity for further research to comprehensively understand the interplay between SDoH, environmental exposures, and lung function across different populations. Future studies should aim to incorporate a wider array of SDoH, such as stress levels, access to healthcare, neighborhood safety, and intergenerational wealth effects. There is also a need for longitudinal studies that can elucidate causal pathways and the potential impact of policy changes on reducing health disparities. Moreover, exploring the intersectionality of race, gender identity, and other demographic factors could provide a more nuanced understanding of how diverse identities influence lung health outcomes. Expanding research to include international cohorts could enhance the generalizability of findings and support the development of global strategies to address lung health disparities.

Certain limitations must be acknowledged. Our reliance on NHANES data restricts generalizability beyond the United States and hinders our ability to explore nuanced race and ethnicity groups. Incomplete understand and limited nature of available data also limits our assessment of complex social and environmental exposures, such as effects of racism, intergenerational wealth effects, life-course exposure to pollutants, violence, stress, and allostatic load. Additionally, the absence of data on gender identity prevented us from analyzing potential differential effects.

<!--[Does SDoH affect FEV1 beyond race?]-->

These findings have important implications for clinical practice and policy. Our results show a larger than previously known effect of complex exposures on racial gaps in lung function, and the true proportion is likely higher than our estimates. However, the racial gaps in lung function cannot yet be completely explained by disparities in complex exposures. The previous guidelines that recommended race-specific reference equations for pulmonary function testing risk assumed racial gaps in lung function were normal and reinforced inequities by perpetuating the notion of race as a biological determinant, rather than acknowledging the role of modifiable social factors[@bhakta2023]. However, the new race-averaged reference equations also fail to account for our understanding of the the effect size of social and environmental exposures on lung function.

## Conclusions

Our study underscores the significant influence of social determinants of health on lung function and shows that a larger proportion of racial gaps in lung function can be explained by social determinants of health than previously reported. However, we were unable to account for all racial differences in lung function based on measured social determinants of health in NHANES.

## References

::: {#refs}
:::

## Appendices

### Participant characteristics by Race

::: {#supptab-missing-ness-by-race}
```{r}
 
 table1(~ age + race_text_nhanes + sex_text + 
          fev1 + fvc +
          smoker_in_household + maternal_smoke +
          mineral_dusts + organic_dusts + exhaust_fumes + other_fumes +
          income_poverty_ratio + home_owner + 
          education_adults + now_attending_school + 
          healthy_diet + vigorous_work + moderate_work + vigorous_recreational + moderate_recreational + bmi 
          | race_text_nhanes, table1)
```

Table 1 by self-identified race
:::

### Separate Analysis by Biological Sex

::: {#suppfig-females}
```{r,  warning=FALSE, message=FALSE}
refs_adult_female <- createCohort("adult", sex="female")
refs_youth_female <- createCohort("youth", sex="female")


plot_racial_gap_change(refs_adult_female, refs_youth_female, single_sex=TRUE)
```

Changes in lung function racial gaps for female participants
:::

::: {#suppfig-males}
```{r, warning=FALSE, message=FALSE}
refs_adult_male <- createCohort("adult", sex="male")
refs_youth_male <- createCohort("youth", sex="male")


plot_racial_gap_change(refs_adult_male, refs_youth_male, single_sex=TRUE)
```

Changes in lung function racial gaps for male participants
:::

### Intersection of Race and Country of Birth

We produced results separately for self-identified Black and White person born in the US.

::: {#suppfig-usborn}
```{r, warning=FALSE, message=FALSE}
refs_adult_US_Black <- createCohort("adult", BirthCountry="US")
# message("Adult counts:")
# message(map_df(refs_adult, count))

refs_youth_US_Black <- createCohort("youth", BirthCountry="US")
# message("Youth counts:")
# message(map_df(refs_youth, count))

plot_racial_gap_change(refs_adult_US_Black, refs_youth_US_Black)
```

Racial gap in lung function among those born in the US
:::

### Income to Poverty Ratio

When we excluded participants with income to poverty ratio under five, the proportion of Black participants decreased from 19% to 10% in youth and 14% to 8% in adults, as shown in @suppfig-incomepovertyratio. The proportion of racial gap in FEV~1~ and FVC that was explained by poverty was 6% and 0% in adults, and 4% and 2% in youth.

::: {#suppfig-incomepovertyratio}
```{r, warning=FALSE, message=FALSE}


refs_adult_incomePovertyRatioOnly <- createCohort("adult", incomePovertyRatioOnly=TRUE)
refs_youth_incomePovertyRatioOnly <- createCohort("youth", incomePovertyRatioOnly=TRUE)

plot_racial_gap_change(refs_adult_incomePovertyRatioOnly, refs_youth_incomePovertyRatioOnly)
```

Changes in lung function racial gaps based on income to poverty ratio
:::

````{=html}
<!-- 


### Establishing the order of exclusion

First, we need to do some preprocessing to create a reference population for evaluation purposes.

```{r, eval=F}

create_ref_for_eval <- function(ageGroup, binaryRace=TRUE) {
  if (!(ageGroup %in% c("adult", "youth", "all_ages"))) stop("Invalid age group")
  nhanes <- readRDS("nhanes_2007_2012.rds") %>%
  mutate(fev1 = fev1_pre/1000,
         fvc  = fvc_pre/1000) %>%
  drop_na(fev1, fvc)

 if (binaryRace) {
   nhanes <- nhanes %>%
     filter(race %in% c(3,4))}

 if (ageGroup=="adult") {
  nhanes_bw <- nhanes %>%
  filter(age>=20)
  message("adult")
}
   
 if (ageGroup=="youth") {
   nhanes_bw <- nhanes %>%
     filter(age<20)
   message("Youth")
 }

if (ageGroup=="all_ages") {
  nhanes_bw <- nhanes 
  message("All Ages")
 }

#vis_miss(nhanes_bw, warn_large_data = F)

ref0 <- nhanes_bw

ref1 <- ref0 %>%
  filter ((is.na(current_smoke) | (current_smoke == "3")) &
         (is.na(ever_100_smoke) | (ever_100_smoke != "1")) &
         (is.na(last_5_days_cigarettes) |  (last_5_days_cigarettes != "1")) &
         (is.na(last_5_days_pipes) | (last_5_days_pipes != "1")) &
         (is.na(last_5_days_cigars) | (last_5_days_cigars != "1")) &
         (is.na(ever_asthma) | (ever_asthma !="1")) &
         (is.na(ever_bronchitis) | (ever_bronchitis != "1")) &
         (is.na(ever_emphysema) | (ever_emphysema != "1")) &
         (is.na(cough_3_month) | (cough_3_month!=1)) & 
         (is.na(phlegm_3_month) | (phlegm_3_month!=1)) & 
         (is.na(wheezing_past_yr) | (wheezing_past_yr!=1)) & 
         (is.na(dry_cough_night_past_yr) | (dry_cough_night_past_yr!=1))) 
  
ref_eval <- ref1 %>% 
    mutate(
     bmi = ifelse((is.na(bmi) | (bmi<=30)), 1,0),
      occupational_exposure = ifelse(
         ((is.na(mineral_dusts) | (mineral_dusts!=1)) & 
         (is.na(organic_dusts)   | (organic_dusts!=1)) & 
         (is.na(exhaust_fumes)   | (exhaust_fumes!=1)) & 
         (is.na(other_fumes)     | (other_fumes!=1))), 
        1, 0),
      maternal_smoke = ifelse(
        ((is.na(maternal_smoke) | (maternal_smoke!=1))), 1, 0),
      smoker_in_household = ifelse(
        ((is.na(smoker_in_household) | (smoker_in_household != "1"))), 1, 0),
      physically_active    = ifelse(((is.na(vigorous_work) | (vigorous_work==1)) | 
         (is.na(vigorous_recreational)   | (vigorous_recreational==1)) | 
         (is.na(moderate_work)   | (moderate_work==1)) | 
         (is.na(moderate_recreational)   | (moderate_recreational==1))), 1, 0),
      healthy_diet = ifelse(((is.na(healthy_diet) | 
               (healthy_diet==1) | 
               (healthy_diet==2) | 
               (healthy_diet==3))), 1, 0),
      general_health = ifelse(
        (general_health==1) |
        (general_health==2), 1, 0), 
      has_insurance = ifelse(((is.na(has_insurance) | 
               (has_insurance==1))), 1, 0),
     education = ifelse(((age>=20) & 
(is.na(education_adults) | (education_adults %in% c(4,5)))) | ((age<20) & (is.na(now_attending_school) | (now_attending_school != 3))),1,0),
      home_ownership = ifelse(
        (is.na(home_ownership) | (home_ownership==1)), 1,0),
     education_adults = ifelse((
(age>=20) &
(is.na(education_adults) | (education_adults %in% c(4,5)))), 1, 0),
     now_attending_school = ifelse(((age<20) & (is.na(now_attending_school) | (now_attending_school != 3))), 1,0),
     survey_weights = importance_weights(MEC6YR)
      ) %>%
    select(
      fev1,
      survey_weights,
      sex,
      age,
      height,
      race,
      race_text_nhanes,
      occupational_exposure,
      maternal_smoke,
      smoker_in_household, 
      bmi,
      general_health,
      physically_active,
      healthy_diet,
      has_insurance,
      education,
      education_adults,
      now_attending_school,
      birth_country,
      home_ownership
    )
return(ref_eval)
}
```

Now we can look at multivariate association ranking.

```{r, eval=FALSE}

compareEffectSizes <- function(ageGroup){
   if (!(ageGroup %in% c("adult", "youth"))) stop("Invalid age group")
 
ref_eval <- create_ref_for_eval(ageGroup)

#TODO decide whether or not general health should appear in main article

if (ageGroup=="adult") {
disparity_rec <- recipe(fev1~sex+age+height+occupational_exposure+
    smoker_in_household+bmi+physically_active+healthy_diet+
    has_insurance+education_adults+home_ownership+survey_weights, data=ref_eval) 
 }

if (ageGroup=="youth") {
  #TODO had to remove occupational exposure and healthy diet for us to have any rows left for complete case analysis. Need to think about how to handle this. 
disparity_rec <- recipe(fev1~sex+age+height+
    smoker_in_household+bmi+physically_active+
    has_insurance+maternal_smoke+now_attending_school+home_ownership+survey_weights, data=ref_eval) 
 }

summary(disparity_rec)

std_rec <- disparity_rec %>%
  step_dummy(all_nominal_predictors()) %>%
  step_center(all_numeric_predictors()) %>%
  step_scale(all_numeric_predictors()) 

trained_rec <- prep(std_rec, training=ref_eval)
  
df_train <- bake(trained_rec, new_data = ref_eval)  

  
lr_mod <- linear_reg()

wflow <- 
  workflow() %>% 
  add_model(lr_mod) %>% 
  add_recipe(std_rec) %>%
  add_case_weights(survey_weights)

lm_fit <- 
  wflow %>% 
  fit(data = ref_eval)

res <- 
  tidy(lm_fit) %>%
  arrange(-abs(estimate))

return(res)
}

 compareEffectSizes("adult")
 compareEffectSizes("youth")
```

Now let's look at ranking univariate associations:

```{r, eval=F}

eval_var_importance <- function(vars_for_rec, ageGroup) {
  if (!(ageGroup %in% c("adult", "youth", "all_ages"))) stop("Invalid age group")
  data <- create_ref_for_eval(ageGroup)
  
  disparity_rec <- recipe(formula(paste("fev1 ~ sex + age + height + survey_weights + ", paste(vars_for_rec, collapse = "+"))), 
                      data = data)  
    
  #print(summary(disparity_rec))

  std_rec <- disparity_rec %>%
    step_dummy(all_nominal_predictors()) %>%
    step_center(all_numeric_predictors()) %>%
    step_scale(all_numeric_predictors()) 

  trained_rec <- prep(std_rec, training = data)

  df_train <- bake(trained_rec, new_data = data)  
  wflow <- 
    workflow() %>% 
    add_model(linear_reg()) %>% 
    add_recipe(std_rec) %>%
    add_case_weights(survey_weights)

  fit_obj <- 
    wflow %>% 
    fit(data = data)

  res <- 
    tidy(fit_obj) %>%
    arrange(-abs(estimate))
  return(res)
}

# adult_vars <- c("occupational_exposure","smoker_in_household","bmi",
#                 "physically_active","healthy_diet","has_insurance","education_adults", "home_ownership")
# 
# youth_vars <- c("occupational_exposure", "smoker_in_household","bmi","physically_active", "has_insurance","maternal_smoke","now_attending_school", "home_ownership")

all_ages_vars <- c("occupational_exposure","smoker_in_household","bmi",
                "physically_active","healthy_diet","has_insurance","education", "home_ownership", "maternal_smoke")

map_dfr(all_ages_vars, 
        ~eval_var_importance(.x, "all_ages"),
        .id = "variable") %>% 
  filter(!(term %in% c("(Intercept)", "height", "age", "sex_X2"))) %>%
  arrange(-abs(estimate))

# 
# map_dfr(adult_vars, 
#         ~eval_var_importance(.x, "adult"),
#         .id = "variable") %>% 
#   filter(!(term %in% c("(Intercept)", "height", "age", "sex_X2"))) %>%
#   arrange(-abs(estimate))
# 
# map_dfr(youth_vars, 
#         ~eval_var_importance(.x, "youth"),
#         .id = "variable") %>% 
#   filter(!(term %in% c("(Intercept)", "height", "age", "sex_X2"))) %>%
#   arrange(-abs(estimate))


```

### Alternative Order of Reference Values

```{r, , eval=F}
createCohortAlt <- function (ageGroup,sex='all') {
  if (!(ageGroup %in% c("adult", "youth"))) 
    stop("Invalid age group")
  if (!(sex %in% c("all", "male", "female"))) 
    stop("Invalid sex")
  

  nhanes <- readRDS("nhanes_2007_2012.rds") 
  
  stopifnot((nhanes %>% count()) == 30442) # Ensure we have the correct n
  stopifnot((nhanes %>% filter(race %in% c(3,4)) %>% count()) == 18359) 
  stopifnot((nhanes %>% drop_na(fev1_pre, fvc_pre)  %>% count()) == 20050) 
  
  if (sex=='female') {
    warning('only females are included.')
    nhanes <- nhanes %>% filter(sex==2)
  }
  
  if (sex=='male') {
    warning('only males are included.')
    nhanes <- nhanes %>% filter(sex==1)
  }

  nhanes <- nhanes %>%
    mutate(fev1 = fev1_pre/1000,
           fvc  = fvc_pre/1000) %>%
    drop_na(fev1, fvc) %>%
    filter(spiro_status_pre == 1) %>%
    filter(fev1_quality_pre == "A" | fev1_quality_pre == "B") %>%
    filter(fvc_quality_pre  == "A" | fvc_quality_pre  == "B") 
  
  message(paste0("NHANES N (excluding missing or low quality spiro: ", 
                 (nhanes %>% count())))
  
  nhanes_bw <- nhanes %>%
        filter(race %in% c(3,4))

  message(paste0("NHANES Black and White N (excluding missing or low quality spiro: ", 
                 (nhanes_bw %>% count())))
  
if (ageGroup=="adult") {
nhanes_bw <- nhanes_bw %>%
  filter(age>=20)

  message(paste0(ageGroup, "-NHANES : ", 
                 (nhanes_bw %>% count())))
}
  
if (ageGroup=="youth") {
nhanes_bw <- nhanes_bw %>%
  filter(age<20)

  message(paste0(ageGroup, "-NHANES : ", 
                 (nhanes_bw %>% count())))
}

ref0 <- nhanes_bw

ref0 %>%
  group_by(race) %>%
  count()

ref1 <- ref0 %>%
  filter ((is.na(current_smoke) | (current_smoke == "3")) &
         (is.na(ever_100_smoke) | (ever_100_smoke != "1")) &
         (is.na(last_5_days_cigarettes) |  (last_5_days_cigarettes != "1")) &
         (is.na(last_5_days_pipes) | (last_5_days_pipes != "1")) &
         (is.na(last_5_days_cigars) | (last_5_days_cigars != "1")) &
         (is.na(ever_asthma) | (ever_asthma !="1")) &
         (is.na(ever_bronchitis) | (ever_bronchitis != "1")) &
         (is.na(ever_emphysema) | (ever_emphysema != "1")) &
         (is.na(cough_3_month) | (cough_3_month!=1)) & 
         (is.na(phlegm_3_month) | (phlegm_3_month!=1)) & 
         (is.na(wheezing_past_yr) | (wheezing_past_yr!=1)) & 
         (is.na(dry_cough_night_past_yr) | (dry_cough_night_past_yr!=1))) %>%
  mutate(ref="reference")

ref2 <- ref1 %>%  
      filter((is.na(smoker_in_household) | (smoker_in_household != "1"))) %>%
  mutate(ref="no second-hand smoke")


ref3 <- ref2 %>%
      filter((is.na(bmi) | (bmi<=30))) %>%
  mutate(ref="not obese")

ref4 <- ref3 %>%
      filter((is.na(vigorous_work) | (vigorous_work==1)) | 
         (is.na(vigorous_recreational)   | (vigorous_recreational==1)) | 
         (is.na(moderate_work)   | (moderate_work==1)) | 
         (is.na(moderate_recreational)   | (moderate_recreational==1))) %>%
  mutate(ref="active")

ref5 <- ref4 %>%
      filter((is.na(maternal_smoke) | (maternal_smoke!=1))) %>%
  mutate(ref="no maternal smoke") #TODO Maternal smoke not available for those over 15 years
  
ref6 <- ref4 %>%
     filter((is.na(has_insurance) | 
               (has_insurance==1))) %>%
  mutate(ref="insured")

ref7 <- ref6 %>%
    filter(is.na(home_ownership) | (home_ownership==1)) %>%
  mutate(ref="home owner")


ref8 <- ref7 %>%
     filter((is.na(healthy_diet) | 
               (healthy_diet==1) | 
               (healthy_diet==2) | 
               (healthy_diet==3))) %>%
  mutate(ref="healthy diet")

ref9 <- ref8 %>%
    filter((is.na(mineral_dusts) | (mineral_dusts!=1)) & 
         (is.na(organic_dusts)   | (organic_dusts!=1)) & 
         (is.na(exhaust_fumes)   | (exhaust_fumes!=1)) & 
         (is.na(other_fumes)     | (other_fumes!=1))) %>%
  mutate(ref="job unexposed")

if (ageGroup=="adult") {
  ref10 <- ref9 %>%
    filter(is.na(education_adults) | (education_adults %in% c(4,5))) %>%
  mutate(ref="educated")
}

if (ageGroup=="youth") {
  ref10 <- ref9 %>%
    filter(is.na(now_attending_school) | (now_attending_school != 3)) %>%
  mutate(ref="educated")
}
refs <- list(ref1, ref2, ref3, ref4, ref5, ref6, ref7, ref8, ref9, ref10)

return(refs)
}

plot_racial_gap_change(createCohortAlt("adult"), createCohortAlt("youth"))

# plot_racial_gap_change_single_sex(createCohortAlt("adult", sex="male"), createCohortAlt("youth", sex="male"))

```

#### Alternate Order 2

```{r, eval=F}
createCohortAlt2 <- function (ageGroup,sex='all') {
  if (!(ageGroup %in% c("adult", "youth"))) 
    stop("Invalid age group")
  if (!(sex %in% c("all", "male", "female"))) 
    stop("Invalid sex")
  

  nhanes <- readRDS("nhanes_2007_2012.rds") 
  
  stopifnot((nhanes %>% count()) == 30442) # Ensure we have the correct n
  stopifnot((nhanes %>% filter(race %in% c(3,4)) %>% count()) == 18359) 
  stopifnot((nhanes %>% drop_na(fev1_pre, fvc_pre)  %>% count()) == 20050) 
  
  if (sex=='female') {
    warning('only females are included.')
    nhanes <- nhanes %>% filter(sex==2)
  }
  
  if (sex=='male') {
    warning('only males are included.')
    nhanes <- nhanes %>% filter(sex==1)
  }

  nhanes <- nhanes %>%
    mutate(fev1 = fev1_pre/1000,
           fvc  = fvc_pre/1000) %>%
    drop_na(fev1, fvc) %>%
    filter(spiro_status_pre == 1) %>%
    filter(fev1_quality_pre == "A" | fev1_quality_pre == "B") %>%
    filter(fvc_quality_pre  == "A" | fvc_quality_pre  == "B") 
  
  message(paste0("NHANES N (excluding missing or low quality spiro: ", 
                 (nhanes %>% count())))
  
  nhanes_bw <- nhanes %>%
        filter(race %in% c(3,4))

  message(paste0("NHANES Black and White N (excluding missing or low quality spiro: ", 
                 (nhanes_bw %>% count())))
  
if (ageGroup=="adult") {
nhanes_bw <- nhanes_bw %>%
  filter(age>=20)

  message(paste0(ageGroup, "-NHANES : ", 
                 (nhanes_bw %>% count())))
}
  
if (ageGroup=="youth") {
nhanes_bw <- nhanes_bw %>%
  filter(age<20)

  message(paste0(ageGroup, "-NHANES : ", 
                 (nhanes_bw %>% count())))
}

ref0 <- nhanes_bw

ref0 %>%
  group_by(race) %>%
  count()

ref1 <- ref0 %>%
  filter ((is.na(current_smoke) | (current_smoke == "3")) &
         (is.na(ever_100_smoke) | (ever_100_smoke != "1")) &
         (is.na(last_5_days_cigarettes) |  (last_5_days_cigarettes != "1")) &
         (is.na(last_5_days_pipes) | (last_5_days_pipes != "1")) &
         (is.na(last_5_days_cigars) | (last_5_days_cigars != "1")) &
         (is.na(ever_asthma) | (ever_asthma !="1")) &
         (is.na(ever_bronchitis) | (ever_bronchitis != "1")) &
         (is.na(ever_emphysema) | (ever_emphysema != "1")) &
         (is.na(cough_3_month) | (cough_3_month!=1)) & 
         (is.na(phlegm_3_month) | (phlegm_3_month!=1)) & 
         (is.na(wheezing_past_yr) | (wheezing_past_yr!=1)) & 
         (is.na(dry_cough_night_past_yr) | (dry_cough_night_past_yr!=1))) %>%
  mutate(ref="reference")

ref2 <- ref1 %>%
    filter((is.na(mineral_dusts) | (mineral_dusts!=1)) & 
         (is.na(organic_dusts)   | (organic_dusts!=1)) & 
         (is.na(exhaust_fumes)   | (exhaust_fumes!=1)) & 
         (is.na(other_fumes)     | (other_fumes!=1))) %>%
  mutate(ref="job unexposed")

ref3 <- ref2 %>%
    filter(is.na(home_ownership) | (home_ownership==1)) %>%
  mutate(ref="home owner")

ref4 <- ref3 %>%
      filter((is.na(bmi) | (bmi<=30))) %>%
  mutate(ref="not obese")

if (ageGroup=="adult") {
  ref5 <- ref4 %>%
    filter(is.na(education_adults) | (education_adults %in% c(4,5))) %>%
  mutate(ref="educated")
}

if (ageGroup=="youth") {
  ref5 <- ref4 %>%
    filter(is.na(now_attending_school) | (now_attending_school != 3)) %>%
  mutate(ref="educated")
}

ref6 <- ref5 %>%
     filter((is.na(has_insurance) | 
               (has_insurance==1))) %>%
  mutate(ref="insured")

ref7 <- ref6 %>%
     filter((is.na(healthy_diet) | 
               (healthy_diet==1) | 
               (healthy_diet==2) | 
               (healthy_diet==3))) %>%
  mutate(ref="healthy diet")

ref8 <- ref7 %>%  
      filter((is.na(smoker_in_household) | (smoker_in_household != "1"))) %>%
  mutate(ref="no 2nd hand smoke")


ref9 <- ref8 %>%
      filter((is.na(maternal_smoke) | (maternal_smoke!=1))) %>%
  mutate(ref="no maternal smoke") #TODO Maternal smoke not available for those over 15 years

ref10 <- ref9 %>%
      filter((is.na(vigorous_work) | (vigorous_work==1)) | 
         (is.na(vigorous_recreational)   | (vigorous_recreational==1)) | 
         (is.na(moderate_work)   | (moderate_work==1)) | 
         (is.na(moderate_recreational)   | (moderate_recreational==1))) %>%
  mutate(ref="active")


refs <- list(ref1, ref2, ref3, ref4, ref5, ref6, ref7, ref8, ref9, ref10)

return(refs)
}

plot_racial_gap_change(createCohortAlt2("adult"), createCohortAlt("youth"))
```

We tried different orders of exclusion and it seems that in adults we see a decline once we have excluded based on three factors: BMI, home ownership, and occupational exposure.

### Non-Cumulative Exclusion

Excluding one by one, instead of nested, to see which variable matters most. It's kind of like variable selection and we want to get the most parsimonious combination that describes the most reduction in racial gap. Must be a smarter way to do this.

```{r}

createCohort1by1 <- function (ageGroup,sex='all') {
  if (!(ageGroup %in% c("adult", "youth"))) 
    stop("Invalid age group")
  if (!(sex %in% c("all", "male", "female"))) 
    stop("Invalid sex")
  

  nhanes <- readRDS("nhanes_2007_2012.rds") 
  
  stopifnot((nhanes %>% count()) == 30442) # Ensure we have the correct n
  stopifnot((nhanes %>% filter(race %in% c(3,4)) %>% count()) == 18359) 
  stopifnot((nhanes %>% drop_na(fev1_pre, fvc_pre)  %>% count()) == 20050) 
  
  if (sex=='female') {
    warning('only females are included.')
    nhanes <- nhanes %>% filter(sex==2)
  }
  
  if (sex=='male') {
    warning('only males are included.')
    nhanes <- nhanes %>% filter(sex==1)
  }

  nhanes <- nhanes %>%
    mutate(fev1 = fev1_pre/1000,
           fvc  = fvc_pre/1000) %>%
    drop_na(fev1, fvc) %>%
    filter(spiro_status_pre == 1) %>%
    filter(fev1_quality_pre == "A" | fev1_quality_pre == "B") %>%
    filter(fvc_quality_pre  == "A" | fvc_quality_pre  == "B") 
  
  message(paste0("NHANES N (excluding missing or low quality spiro: ", 
                 (nhanes %>% count())))
  
  nhanes_bw <- nhanes %>%
        filter(race %in% c(3,4))

  message(paste0("NHANES Black and White N (excluding missing or low quality spiro: ", 
                 (nhanes_bw %>% count())))
  
if (ageGroup=="adult") {
nhanes_bw <- nhanes_bw %>%
  filter(age>=20)

  message(paste0(ageGroup, "-NHANES : ", 
                 (nhanes_bw %>% count())))
}
  
if (ageGroup=="youth") {
nhanes_bw <- nhanes_bw %>%
  filter(age<20)

  message(paste0(ageGroup, "-NHANES : ", 
                 (nhanes_bw %>% count())))
}

ref0 <- nhanes_bw

ref0 %>%
  group_by(race) %>%
  count()

ref1 <- ref0 %>%
  filter ((is.na(current_smoke) | (current_smoke == "3")) &
         (is.na(ever_100_smoke) | (ever_100_smoke != "1")) &
         (is.na(last_5_days_cigarettes) |  (last_5_days_cigarettes != "1")) &
         (is.na(last_5_days_pipes) | (last_5_days_pipes != "1")) &
         (is.na(last_5_days_cigars) | (last_5_days_cigars != "1")) &
         (is.na(ever_asthma) | (ever_asthma !="1")) &
         (is.na(ever_bronchitis) | (ever_bronchitis != "1")) &
         (is.na(ever_emphysema) | (ever_emphysema != "1")) &
         (is.na(cough_3_month) | (cough_3_month!=1)) & 
         (is.na(phlegm_3_month) | (phlegm_3_month!=1)) & 
         (is.na(wheezing_past_yr) | (wheezing_past_yr!=1)) & 
         (is.na(dry_cough_night_past_yr) | (dry_cough_night_past_yr!=1))) %>%
  mutate(ref="reference")

ref2 <- ref0 %>%
    filter((is.na(mineral_dusts) | (mineral_dusts!=1)) & 
         (is.na(organic_dusts)   | (organic_dusts!=1)) & 
         (is.na(exhaust_fumes)   | (exhaust_fumes!=1)) & 
         (is.na(other_fumes)     | (other_fumes!=1))) %>%
  mutate(ref="job unexposed")

ref3 <- ref0 %>%
    filter(is.na(home_ownership) | (home_ownership==1)) %>%
  mutate(ref="home owner")

ref4 <- ref0 %>%
      filter((is.na(bmi) | (bmi<=30))) %>%
  mutate(ref="not obese")

if (ageGroup=="adult") {
  ref5 <- ref0 %>%
    filter(is.na(education_adults) | (education_adults %in% c(4,5))) %>%
  mutate(ref="educated")
}

if (ageGroup=="youth") {
  ref5 <- ref0 %>%
    filter(is.na(now_attending_school) | (now_attending_school != 3)) %>%
  mutate(ref="educated")
}

ref6 <- ref0 %>%
     filter((is.na(has_insurance) | 
               (has_insurance==1))) %>%
  mutate(ref="insured")

ref7 <- ref0 %>%
     filter((is.na(healthy_diet) | 
               (healthy_diet==1) | 
               (healthy_diet==2) | 
               (healthy_diet==3))) %>%
  mutate(ref="healthy diet")

ref8 <- ref0 %>%  
      filter((is.na(smoker_in_household) | (smoker_in_household != "1"))) %>%
  mutate(ref="no 2nd hand smoke")

ref9 <- ref0 %>%
      filter((is.na(maternal_smoke) | (maternal_smoke!=1))) %>%
  mutate(ref="no maternal smoke") #TODO Maternal smoke not available for those over 15 years
  
ref10 <- ref0 %>%
      filter((is.na(vigorous_work) | (vigorous_work==1)) | 
         (is.na(vigorous_recreational)   | (vigorous_recreational==1)) | 
         (is.na(moderate_work)   | (moderate_work==1)) | 
         (is.na(moderate_recreational)   | (moderate_recreational==1))) %>%
  mutate(ref="active")

refs <- list(ref1, ref2, ref3, ref4, ref5, ref6, ref7, ref8, ref9, ref10)

return(refs)
}

plot_racial_gap_change(createCohort1by1("adult"), createCohort1by1("youth"))
```


## Reference Equations

```{r, warning=FALSE, message=FALSE, eval=F}
#| label: fig-refeq1
#| fig-cap: ref eq1
 
plot_racial_gap_change(refs_adult, refs_youth, metric1="fev1", metric2="predicted_fev1_gli2012")
plot_racial_gap_change(refs_adult, refs_youth, metric1="fev1", metric2="predicted_fev1_gli_global")

```


### Effect of Home Ownership

```{r, eval=F}

refs_adult_homeOwnershipOnly <- createCohort("adult", homeOwnershipOnly=TRUE)
refs_youth_homeOwnershipOnly <- createCohort("youth", homeOwnershipOnly=TRUE)

plot_racial_gap_change(refs_adult_homeOwnershipOnly, refs_youth_homeOwnershipOnly)
```




### Differential Missingness by Race

Also, good to explore the relative difference in missingness. And we should probably do multiple imputation.

```{r, warning=FALSE, eval=F}
missingnessByRace <- function(df){
df <- df %>% 
    select(mineral_dusts, organic_dusts, exhaust_fumes, other_fumes, race_text_nhanes,
           home_ownership, bmi, education_adults, now_attending_school, has_insurance, healthy_diet, smoker_in_household, vigorous_work,  vigorous_recreational, moderate_work, moderate_recreational, ever_100_smoke, ever_asthma, ever_bronchitis, ever_emphysema, cough_3_month, phlegm_3_month, wheezing_past_yr, dry_cough_night_past_yr ) 
  vis_miss(df, facet=race_text_nhanes)
}

```

#### Adults

```{r, warning=FALSE, eval=F}

lapply(refs_adult, missingnessByRace)
```

#### Youth

```{r, warning=FALSE, eval=F}

lapply(refs_youth, missingnessByRace)
```
#### Gap between White people and non-US born Black people

```{r, warning=FALSE, eval=F}
refs_adult_OtherCountries_Black <- createCohort("adult", BirthCountry="Other countries")
#message("Adult counts:")
#message(map_df(refs_adult, count))

refs_youth_OtherCountries_Black <- createCohort("youth", BirthCountry="Other countries")
#message("Youth counts:")
#message(map_df(refs_youth, count))

plot_racial_gap_change(refs_adult_OtherCountries_Black, refs_youth_OtherCountries_Black)
```

#### Adults

```{r, warning=FALSE, eval=F}
disparityDistBirthCountry <- function(data, var) {
    data %>%
    group_by(race_text_nhanes, sex, birth_country) %>%
    drop_na(.data[[var]]) %>%
    summarise(value = sum(.data[[var]] == 1, na.rm = TRUE)/n()*100) %>%
    ungroup() %>%
    ggplot() +
    geom_col(aes(x = value, y = race_text_nhanes, fill = birth_country), position = "dodge") +
    theme_few()
}

purrr::map(adults_eval_variables, disparityDistBirthCountry, data = adults_eval)

```

#### Youth

```{r, warning=FALSE, eval=F}
purrr::map(youth_eval_variables, disparityDistBirthCountry, data = youth_eval)

```

### Visualizing Disparities

Let's look at income disparities:

```{r, warning=FALSE, eval=F}

# compareIncome <- function(race, sex, title) {
#     data <- refs_adult[[1]] %>% filter(race_text_nhanes == race & sex==sex)
#     p_income <- ggplot(data, aes(income_poverty_ratio)) +
#         geom_histogram(aes(y = 100*after_stat(count / sum(count)), weight =MEC6YR), 
#         alpha=0.6, position="identity") + 
#         ylim(0,50) + 
#         ylab("Percentage") + 
#         ggtitle(title) +
#         theme_few() 
#     return(p_income)
# }    
# 
# compareIncome("Non-Hispanic White", 1, "White Males")
# 
# compareIncome("Non-Hispanic Black", 1, "Black Males")
#     

white_males   <- refs_adult[[1]] %>% 
  filter(race_text_nhanes=="Non-Hispanic White" & sex==1)
white_females <- refs_adult[[1]] %>% 
  filter(race_text_nhanes=="Non-Hispanic White" & sex==2)

black_males   <- refs_adult[[1]] %>% 
  filter(race_text_nhanes=="Non-Hispanic Black"& sex==1)
black_females <- refs_adult[[1]] %>% 
  filter(race_text_nhanes=="Non-Hispanic Black"& sex==2)


p_white_males <- ggplot(white_males, aes(income_poverty_ratio)) +
    geom_histogram(aes(y = 100*after_stat(count / sum(count)), weight =MEC6YR), alpha=0.6, position="identity") + ylim(0,50) + ylab("Percentage") + ggtitle("White Males") +
  theme_few() 

p_white_females <- ggplot(white_females, aes(income_poverty_ratio)) +
    geom_histogram(aes(y = 100*after_stat(count / sum(count)), weight =MEC6YR), alpha=0.6, position="identity") + ylim(0,50) + ylab("Percentage") + ggtitle("White Females") +
  theme_few() 

p_black_males <- ggplot(black_males, aes(income_poverty_ratio)) +
    geom_histogram(aes(y = 100*after_stat(count / sum(count)), weight =MEC6YR), alpha=0.6, position="identity")  + ylim(0,50) + ylab("Percentage") + ggtitle("Black Males") +
  theme_few()

p_black_females <- ggplot(black_females, aes(income_poverty_ratio)) +
    geom_histogram(aes(y = 100*after_stat(count / sum(count)), weight =MEC6YR), alpha=0.6, position="identity")  + ylim(0,50) + ylab("Percentage") + ggtitle("Black Females") +
  theme_few()

(p_black_males + p_black_females)/(p_white_males+p_white_females) + plot_layout(axes = "collect")

refs_adult[[1]] %>% 
  group_by(race_text_nhanes, sex) %>%   
  summarise(total_people = n(),
            income_five_times_poverty = sum(income_poverty_ratio == 5, na.rm = TRUE),
            proportion = income_five_times_poverty / total_people)

refs_adult[[1]] %>% 
  group_by(race_text_nhanes, sex, birth_country) %>%   
  summarise(total_people = n(),
            income_five_times_poverty = sum(income_poverty_ratio == 5, na.rm = TRUE),
            proportion = income_five_times_poverty / total_people)
```

Now let's look at education in adults, and occupational exposures.

More efficient code:

```{r, warning=FALSE, eval=F}
disparityDist <- function(data, var) {
    data %>%
    group_by(race_text_nhanes, sex) %>%
    drop_na(.data[[var]]) %>%
    summarise(value = sum(.data[[var]] == 1, na.rm = TRUE)/n()*100) %>%
    ungroup() %>%
    ggplot() +
    geom_col(aes(x = value, y = race_text_nhanes, fill = sex), position = "dodge") +
    theme_few()
}

adults_eval <- create_ref_for_eval("adult", binaryRace = FALSE)

adults_eval_variables <- c("education_adults", "occupational_exposure", "smoker_in_household", 
                           "physically_active", "healthy_diet", "general_health", "has_insurance")

purrr::map(adults_eval_variables, disparityDist, data = adults_eval)


```

and for youth:

```{r, warning=FALSE, eval=F}

youth_eval <- create_ref_for_eval("youth", binaryRace = FALSE)
youth_eval_variables <- c("now_attending_school", "occupational_exposure", "smoker_in_household", 
                          "maternal_smoke", "physically_active", "healthy_diet", "general_health", "has_insurance")

purrr::map(youth_eval_variables, disparityDist, data = youth_eval)

```

### Emotional Support

Social support questionnaire is only available in 2007-2008, but even in that cycle more than half of the data is missing and remainder has a huge class imbalance, so it'd be hard to evaluate the effect of emotional support on racial gap in lung function.


## Lung Function vs. Age

### Adults

```{r, warning=FALSE, eval=F}

fev1_age_race <- function(df) {
  ggplot(df, aes(y=fev1, x=age, col=race_text_nhanes)) +
    geom_point(size=0.1, alpha=0.4) +
    geom_smooth() +
    theme_few() +
    facet_wrap(~sex)
}

fev1_height_race <- function(df) {
  ggplot(df, aes(y=fev1, x=height, col=race_text_nhanes)) +
    geom_point(size=0.1) +
    geom_smooth() +
    theme_few() +
    facet_wrap(~sex)
}

lapply(refs_adult, fev1_age_race)

```

### Youth

```{r, warning=FALSE, eval=F}

lapply(refs_youth, fev1_age_race)

```

## Lung Function vs. Height

### Adults

```{r, warning=FALSE, eval=F}

lapply(refs_adult, fev1_height_race)

```

### Youth

```{r, warning=FALSE, eval=F}

lapply(refs_youth, fev1_height_race)

```
-->
````
